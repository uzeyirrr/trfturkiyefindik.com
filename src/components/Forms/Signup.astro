---
// PocketBase API'sini import et
import { auth } from '../../lib/pocketbase.js';
---

<section>
  <div class="px-8 py-32 mx-auto md:px-12 lg:px-24 max-w-7xl ">
    <div class="max-w-lg mx-auto text-center">
      <h2
        class="text-xl leading-tight tracking-tight sm:text-2xl md:text-3xl capitalize lg:text-4xl font-semibold text-base-900 lg:text-balance"
      >
        Topluluğumuza katılın
      </h2>
      <p class="text-base leading-normal mt-4 text-base-500 font-medium">
        Fındık ticaretinizi dijitalleştirmek için kayıt olun ve hemen başlayın.
      </p>
    </div>
    <form id="signupForm" class="mx-auto mt-12 max-w-lg">
      <div class="flex flex-col gap-y-6">
        <div>
          <label class="text-base leading-normal text-base-500 font-medium">
            Ad Soyad
          </label>
          <div class="mt-2.5">
            <input
              type="text"
              name="name"
              id="name"
              autocomplete="name"
              required
              aria-required="true"
              aria-describedby="name-error"
              placeholder="Adınız ve soyadınız"
              class="block w-full h-10 px-4 py-2 text-sm text-accent-700 duration-300 bg-white border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-accent-500 focus:ring-offset-2 focus:ring-2 sm:text-sm"
            />
            <span id="name-error" class="text-red-600 text-sm hidden">
              Lütfen adınızı girin.
            </span>
          </div>
        </div>
        <div>
          <label class="text-base leading-normal text-base-500 font-medium">
            E-posta
          </label>
          <div class="mt-2.5">
            <input
              type="email"
              name="email"
              id="email"
              autocomplete="email"
              required
              aria-required="true"
              aria-describedby="email-error"
              placeholder="E-posta adresiniz"
              class="block w-full h-10 px-4 py-2 text-sm text-accent-700 duration-300 bg-white border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-accent-500 focus:ring-offset-2 focus:ring-2 sm:text-sm"
            />
            <span id="email-error" class="text-red-600 text-sm hidden">
              Lütfen geçerli bir e-posta adresi girin.
            </span>
          </div>
        </div>
        <div>
          <label class="text-base leading-normal text-base-500 font-medium">
            Şifre
          </label>
          <div class="mt-2.5">
            <input
              type="password"
              name="password"
              id="password"
              autocomplete="new-password"
              required
              aria-required="true"
              aria-describedby="password-error"
              placeholder="Şifreniz (en az 8 karakter)"
              minlength="8"
              class="block w-full h-10 px-4 py-2 text-sm text-accent-700 duration-300 bg-white border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-accent-500 focus:ring-offset-2 focus:ring-2 sm:text-sm"
            />
            <span id="password-error" class="text-red-600 text-sm hidden">
              Lütfen en az 8 karakterli şifre girin.
            </span>
          </div>
        </div>
        <div>
          <label class="text-base leading-normal text-base-500 font-medium">
            Şifre Tekrar
          </label>
          <div class="mt-2.5">
            <input
              type="password"
              name="passwordConfirm"
              id="passwordConfirm"
              autocomplete="new-password"
              required
              aria-required="true"
              aria-describedby="passwordConfirm-error"
              placeholder="Şifrenizi tekrar girin"
              class="block w-full h-10 px-4 py-2 text-sm text-accent-700 duration-300 bg-white border border-transparent rounded-lg appearance-none ring-1 ring-base-200 placeholder-base-400 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-accent-500 focus:ring-offset-2 focus:ring-2 sm:text-sm"
            />
            <span id="passwordConfirm-error" class="text-red-600 text-sm hidden">
              Şifreler eşleşmiyor.
            </span>
          </div>
        </div>
        <div>
          <label class="text-base leading-normal text-base-500 font-medium">
            Hesap Türü
          </label>
          <div class="mt-2.5">
            <select
              name="role"
              id="role"
              required
              aria-required="true"
              class="block w-full h-10 px-4 py-2 text-sm text-accent-700 duration-300 bg-white border border-transparent rounded-lg appearance-none ring-1 ring-base-200 focus:border-base-300 focus:bg-transparent focus:outline-none focus:ring-accent-500 focus:ring-offset-2 focus:ring-2 sm:text-sm"
            >
              <option value="">Hesap türünü seçin</option>
              <option value="user">Üretici</option>
              <option value="factory">Fabrika</option>
              <option value="company">Kurumsal</option>
            </select>
          </div>
        </div>
      </div>
      <div class="flex items-center mt-4 gap-3">
        <input
          id="agreement"
          name="agreement"
          type="checkbox"
          required
          class="size-4 rounded border-base-300 text-accent-600 focus:ring-accent-600 shadow"
        />
        <label class="undefined block text-sm text-base-500 font-medium">
          <a
            class="text-base leading-normal text-accent-500 font-medium hover:text-base-500"
            href="/terms"
          >
            Kullanım Şartları
          </a>
          ve
          <a
            class="text-base leading-normal text-accent-500 font-medium hover:text-base-500"
            href="/privacy"
          >
            Gizlilik Politikası
          </a>
          'nı kabul ediyorum
        </label>
      </div>
      <div class="mt-10">
        <button
          type="submit"
          id="signupBtn"
          class="flex items-center justify-center transition-all duration-200 focus:ring-2 focus:outline-none text-white bg-accent-600 hover:bg-accent-700 focus:ring-accent-500/50 h-10 px-6 py-3 text-base font-medium rounded-lg w-full"
        >
          <span id="signupBtnText">Kayıt Ol</span>
          <div id="signupBtnSpinner" class="hidden ml-2">
            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
          </div>
        </button>
      </div>
      <div id="signupMessage" class="mt-4 text-center hidden">
        <p id="signupMessageText" class="text-sm font-medium"></p>
      </div>
      <div class="flex items-center mt-4">
        <p class="text-sm leading-normal text-base-500 font-medium">
          Zaten hesabınız var mı?
          <a
            class="text-base leading-normal text-accent-500 font-medium hover:text-base-500"
            href="/login"
          >
            Giriş Yap
          </a>
        </p>
      </div>
    </form>
  </div>
</section>

<script>
  document.getElementById('signupForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target as HTMLFormElement;
    const submitBtn = document.getElementById('signupBtn') as HTMLButtonElement;
    const btnText = document.getElementById('signupBtnText') as HTMLSpanElement;
    const btnSpinner = document.getElementById('signupBtnSpinner') as HTMLDivElement;
    const messageDiv = document.getElementById('signupMessage') as HTMLDivElement;
    const messageText = document.getElementById('signupMessageText') as HTMLParagraphElement;
    
    // Form verilerini al
    const formData = new FormData(form);
    const name = formData.get('name');
    const email = formData.get('email');
    const password = formData.get('password');
    const passwordConfirm = formData.get('passwordConfirm');
    const role = formData.get('role');
    const agreement = formData.get('agreement');
    
    // Validasyon
    if (!agreement) {
      showMessage('Lütfen kullanım şartlarını kabul edin.', 'error');
      return;
    }
    
    if (password !== passwordConfirm) {
      showMessage('Şifreler eşleşmiyor.', 'error');
      return;
    }
    
    // Loading durumu
    submitBtn.disabled = true;
    btnText.textContent = 'Kayıt olunuyor...';
    btnSpinner.classList.remove('hidden');
    hideMessage();
    
    try {
      // PocketBase API'sini çağır
      const response = await fetch('/api/auth/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          name,
          email,
          password,
          passwordConfirm,
          role
        })
      });
      
      const result = await response.json();
      
      if (result.success) {
        showMessage('Kayıt başarılı! Giriş sayfasına yönlendiriliyorsunuz...', 'success');
        setTimeout(() => {
          window.location.href = '/login';
        }, 2000);
      } else {
        showMessage(result.error || 'Kayıt sırasında bir hata oluştu.', 'error');
      }
    } catch (error) {
      showMessage('Bağlantı hatası. Lütfen tekrar deneyin.', 'error');
    } finally {
      // Loading durumunu kaldır
      submitBtn.disabled = false;
      btnText.textContent = 'Kayıt Ol';
      btnSpinner.classList.add('hidden');
    }
  });
  
  function showMessage(message, type) {
    const messageDiv = document.getElementById('signupMessage');
    const messageText = document.getElementById('signupMessageText');
    
    messageText.textContent = message;
    messageDiv.className = `mt-4 text-center p-3 rounded-lg ${
      type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
    }`;
    messageDiv.classList.remove('hidden');
  }
  
  function hideMessage() {
    document.getElementById('signupMessage').classList.add('hidden');
  }
</script>
